<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Login - Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .warning { background: #fff3e0; color: #ef6c00; }
        input, button { margin: 5px; padding: 8px; }
        button { cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç Teste de Login e Token - Debug</h1>
    
    <div>
        <h3>1. Teste de Login</h3>
        <input type="email" id="email" value="cliente@sigatrans.com.br" placeholder="Email">
        <input type="password" id="password" value="132456" placeholder="Senha">
        <button onclick="testLogin()">Fazer Login</button>
    </div>

    <div>
        <h3>2. Teste de Verifica√ß√£o de Sess√£o</h3>
        <button onclick="testSession()">Verificar Sess√£o</button>
    </div>

    <div>
        <h3>3. Estado Atual</h3>
        <button onclick="checkCurrentState()">Verificar Estado</button>
    </div>

    <div>
        <h3>4. Limpar Dados</h3>
        <button onclick="clearData()">Limpar LocalStorage</button>
    </div>

    <div id="logs"></div>

    <script>
        // Fun√ß√£o para adicionar logs na tela
        function addLog(message, type = 'log') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logs.appendChild(logDiv);
            console.log(message);
        }

        // Configura√ß√£o da URL base (igual ao main.js)
        const BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3301'
            : 'https://fy5gyeix2g.execute-api.sa-east-1.amazonaws.com/dev';

        addLog(`üåê URL Base: ${BASE_URL}`);

        // Fun√ß√£o para recuperar token (igual ao main.js)
        function getAccessToken() {
            try {
                // Primeiro tenta obter do cookie
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'accessToken') {
                        return value;
                    }
                }

                // Verifica no localStorage
                const tokenData = localStorage.getItem('tokenData');
                if (tokenData) {
                    const parsedTokenData = JSON.parse(tokenData);
                    if (parsedTokenData.accessToken) {
                        return parsedTokenData.accessToken;
                    }
                }
                
                return null;
            } catch (error) {
                addLog(`‚ùå Erro ao recuperar token: ${error.message}`, 'error');
                return null;
            }
        }

        // Fun√ß√£o Thefetch simplificada para teste
        async function Thefetch(path, method = 'GET', body = null) {
            const url = `${BASE_URL}${path}`;
            
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            };

            // Adiciona token se dispon√≠vel
            const accessToken = getAccessToken();
            if (accessToken) {
                options.headers['Authorization'] = `Bearer ${accessToken}`;
                addLog(`üîë Token adicionado ao header: ${accessToken.substring(0, 20)}...`);
            } else {
                addLog(`‚ö†Ô∏è Nenhum token encontrado para enviar`, 'warning');
            }

            if (body) {
                options.body = JSON.stringify(body);
            }

            addLog(`üì° Fazendo requisi√ß√£o: ${method} ${path}`);
            addLog(`üìã Headers: ${JSON.stringify(options.headers, null, 2)}`);
            
            try {
                const response = await fetch(url, options);
                const payload = await response.json().catch(() => ({}));

                addLog(`üì• Resposta recebida (${response.status}): ${JSON.stringify(payload, null, 2)}`);

                if (!response.ok) {
                    if (payload.code === 'ACCESS_TOKEN_MISSING' || response.status === 401) {
                        addLog(`üö´ Erro de token: ${payload.message}`, 'error');
                    }
                    throw new Error(payload.message || 'Erro na requisi√ß√£o');
                }

                return payload;
            } catch (error) {
                addLog(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
                throw error;
            }
        }

        // Fun√ß√£o para fazer login
        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            addLog(`üîê Tentando fazer login com: ${email}`);

            try {
                const result = await Thefetch('/api/auth/login', 'POST', {
                    email: email,
                    password: password
                });

                if (result && result.success) {
                    addLog(`‚úÖ Login realizado com sucesso!`, 'success');
                    addLog(`üë§ Dados recebidos: ${JSON.stringify(result, null, 2)}`);

                    // Simular salvamento de dados (como faz o AuthManager)
                    if (result.data && result.data.user) {
                        localStorage.setItem('userData', JSON.stringify(result.data.user));
                        addLog(`üíæ Dados do usu√°rio salvos no localStorage`);
                    }

                    // Salvar token se dispon√≠vel
                    const tokenData = {
                        loginTime: Date.now(),
                        expiresAt: Date.now() + (24 * 60 * 60 * 1000)
                    };

                    if (result.token || result.accessToken) {
                        tokenData.accessToken = result.token || result.accessToken;
                        addLog(`üîë Token salvo: ${tokenData.accessToken.substring(0, 20)}...`);
                    } else if (result.data && (result.data.token || result.data.accessToken)) {
                        tokenData.accessToken = result.data.token || result.data.accessToken;
                        addLog(`üîë Token salvo (data): ${tokenData.accessToken.substring(0, 20)}...`);
                    } else {
                        addLog(`‚ö†Ô∏è Nenhum token encontrado na resposta`, 'warning');
                    }

                    localStorage.setItem('tokenData', JSON.stringify(tokenData));
                    
                    // Verificar cookies
                    addLog(`üç™ Cookies ap√≥s login: ${document.cookie}`);
                    
                } else {
                    addLog(`‚ùå Login falhou: ${result?.message || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erro no login: ${error.message}`, 'error');
            }
        }

        // Fun√ß√£o para testar verifica√ß√£o de sess√£o
        async function testSession() {
            addLog(`üîç Verificando sess√£o...`);

            try {
                const result = await Thefetch('/api/auth/session', 'GET');
                addLog(`‚úÖ Sess√£o v√°lida: ${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                addLog(`‚ùå Erro na verifica√ß√£o de sess√£o: ${error.message}`, 'error');
            }
        }

        // Fun√ß√£o para verificar estado atual
        function checkCurrentState() {
            addLog(`üìä === ESTADO ATUAL ===`);
            
            // LocalStorage
            const userData = localStorage.getItem('userData');
            const tokenData = localStorage.getItem('tokenData');
            
            if (userData) {
                addLog(`üë§ UserData: ${userData}`);
            } else {
                addLog(`‚ùå Nenhum userData encontrado`, 'error');
            }
            
            if (tokenData) {
                addLog(`üîë TokenData: ${tokenData}`);
            } else {
                addLog(`‚ùå Nenhum tokenData encontrado`, 'error');
            }
            
            // Cookies
            addLog(`üç™ Cookies: ${document.cookie || 'Nenhum cookie'}`);
            
            // Token atual
            const currentToken = getAccessToken();
            if (currentToken) {
                addLog(`üéØ Token atual: ${currentToken.substring(0, 30)}...`);
            } else {
                addLog(`‚ùå Nenhum token atual dispon√≠vel`, 'error');
            }
        }

        // Fun√ß√£o para limpar dados
        function clearData() {
            localStorage.clear();
            document.cookie = 'accessToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            addLog(`üßπ Dados limpos`, 'success');
        }

        // Verificar estado inicial
        window.onload = function() {
            addLog(`üöÄ P√°gina carregada. Verificando estado inicial...`);
            checkCurrentState();
        };
    </script>
</body>
</html>